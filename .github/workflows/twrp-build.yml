name: Build TWRP Recovery
on:
  workflow_dispatch: # Biar bisa diklik tombol "Run" manual

jobs:
  build:
    runs-on: ubuntu-20.04
    
    steps:
    # 1. BERSIH-BERSIH HARDISK (Penting biar gak penuh)
    - name: Maximize Build Space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'

    # 2. INSTALL ALAT PERANG (Git, Compiler, Python)
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install git-core gnupg flex bison gperf build-essential \
        zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 \
        lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev ccache \
        libgl1-mesa-dev libxml2-utils xsltproc unzip python3

    # 3. SETTING IDENTITAS DIRI (Syarat Git)
    - name: Set Git Identity
      run: |
        git config --global user.name "Bot-Builder"
        git config --global user.email "bot@github.com"

    # 4. DOWNLOAD SUMBER KODE (Repo Init & Sync)
    # Kita pake 'Minimal Manifest' biar ukurannya kecil (cuma ~15GB)
    - name: Download Source Code
      run: |
        mkdir twrp
        cd twrp
        repo init --depth=1 -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni.git -b twrp-9.0
        repo sync -c -j$(nproc) --force-sync --no-clone-bundle --no-tags

    # 5. DOWNLOAD DEVICE TREE (Ganti Link Ini Sesuai HP Lu!)
    # Contoh: Samsung Galaxy M21 (m21)
    - name: Clone Device Tree
      run: |
        cd twrp
        # Ini link khusus M21
        git clone https://github.com/m21-dev/android_device_samsung_m21-TWRP.git device/samsung/m21

    # 6. MULAI MASAK (Build)
    - name: Start Building
      run: |
        cd twrp
        export ALLOW_MISSING_DEPENDENCIES=true
        . build/envsetup.sh
        # Ini mantra pemanggil M21
        lunch omni_m21-eng
        mka recoveryimage

    # 7. UPLOAD HASIL (Biar bisa didownload)
    - name: Upload Recovery Image
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-Recovery
        path: twrp/out/target/product/*/recovery.img
